---
layout: post
pusblished: true
title:  "Chloropleth map of France"
date: 2015-03-03 
categories: 
    - R 
    - Data science
    - Geographical data
    - Graphical representation 
---

```{r prepare_chuncks, echo=FALSE, results='hide'}

# Importer le package knitr pour spécifier des options
library(knitr)

# Pas d'écho car je ne veux pas montrer les commandes utilisées dans mon rapport.
opts_chunk$set(warning=FALSE, message=FALSE,
            fig.align = "center",
            fig.path = "assets/france_map/")
opts_knit$set(base.url = "/")
```

A popular way to represent data on a map is the [cloropleth map](http://en.wikipedia.org/wiki/Choropleth_map). It's possible to produce this kind of map with [_R_](http://www.r-project.org/) but I never took the time to achieve it. I'm actually working on some report system and I have to represent geographical data about France. One constraint is I have to produce a printable and grey tones map, ready to be pusblished. Furthermore, the cloropleth map must use a french specific territorial unit: the [department](http://en.wikipedia.org/wiki/Department_%28country_subdivision%29).

The aim of this post is to create a simple but nice chloropleth map with R of the French population to the administrative department level.

## Gather Data

I will use data from the [French institute of Statistics (INSEE)](http://insee.fr). We will use the [file about the population by deparment](http://insee.fr/fr/ppp/bases-de-donnees/donnees-detaillees/estim-pop/estim-pop-dep-sexe-gca-1975-2014.xls). 

```{r, eval = FALSE}
# Download the raw XLS file
raw_xls <- file.path(tempdir(), "pop_french.xls")
download.file(
    url = "http://insee.fr/fr/ppp/bases-de-donnees/donnees-detaillees/estim-pop/estim-pop-dep-sexe-gca-1975-2014.xls", 
    destfile = raw_xls, 
    method = "wget"
    )
```

```{r download_insee, results='hide', echo = FALSE}
raw_xls <- "pop_french.xls"
if( raw_xls %in% dir() ){
    # do nothing
} else {
    download.file(
        url = "http://insee.fr/fr/ppp/bases-de-donnees/donnees-detaillees/estim-pop/estim-pop-dep-sexe-gca-1975-2014.xls", 
        destfile = raw_xls, 
        method = "wget"
        )
}
```

The file is a ugly XLS, then we will use the package _xlsx_ to open it.

```{r open_xls, cached = TRUE}
library(xlsx)
# Data of 2014 are on sheet one
raw_db <- read.xlsx(
    file = raw_xls, 
    sheetIndex = 2, 
    header = FALSE, 
    colClasses = "character"
    )
dim(raw_db)
head(raw_db[, 1:10])
tail(raw_db[, 1:10])
```

It's really an ugly tabular data because header are not on the first line and data after. Then we will need to clean it.

We only need 3 columns :

- _1_: Department's number
- _2_: Department's name
- _8_: Total Population

Data start at line 6 and end at line 106.

```{r}
clean_data <- raw_db[6:106, c(1,2,8)]
dim(clean_data)
# Check the end of the data
tail(clean_data)
```

Line 102 is just a sum then delete it.

```{r}
clean_data <- clean_data[complete.cases(clean_data),]
```

Do a better table

```{r create_clean_db}
db <- data.frame(
    dept = as.character(clean_data$X1),
    pop = as.integer(as.character(clean_data$X8)),
    row.names = clean_data$X2,
    stringsAsFactors = FALSE
    )
```

Finaly we have a clean data frame

```{r, echo = FALSE}
library(knitr)
kable(db)
```

## Find a map of France

```{r}
library(sp)
```

According to this [post](http://web.stanford.edu/~cengel/cgi-bin/anthrospace/download-global-administrative-areas-as-rdata-files), maps can be downloaded from [Global Administrative Areas (GADM)](http://gadm.org).

```{r download_map, echo = FALSE, results='hide'}
con <- "FRA_adm2.RData"
if (con %in% dir()) {
# do nothing
} else {
    download.file(
            url = "http://biogeo.ucdavis.edu/data/gadm2/R/FRA_adm2.RData", 
            destfile = con, 
            method = "wget"
            )
}
```

```{r, eval = FALSE}
con <- url("http://biogeo.ucdavis.edu/data/gadm2/R/FRA_adm2.RData")
```
```{r}
print(load(con))
```

```{r, eval = FALSE}
close(con)
```

Now we have a new `gadm` object in our environment.

## Try the map

With this, it's possible to plot an empty map just to check if we have the good file.

```{r}
library(sp)
plot(gadm)
```

## Merge map data and pop data

Now we have to put together the data from the map and data about population

```{r explore_gadm}
str(gadm, max.level = 2)
```

```{r}

```

```{r}
gadm$regions <- as.factor(gadm@data$NAME_1)
colorss <- rainbow(length(levels(gadm$regions)))
spplot(gadm, "regions", col.regions = colorss)
```

Now, do the same but with popultation

```{r}
dbs <- merge(gadm@data, db, by.x = "ID_2", by.y = "dept", all.x = TRUE, all.y = FALSE)
# Discretize

gadm$pop <- cut(x = dbs$pop, breaks = 6)
color_pop <- heat.colors(6)

spplot(gadm, "pop", col.regions = color_pop)
```

Not bad but there is some department missing.

